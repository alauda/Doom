---
weight: 30
i18n:
  title:
    en: Prerequisites
    ru: Предварительные требования
title: Предварительные требования
sourceSHA: d99dd77d8f543e60d07347aa6d856f3b9dd5fdc4e61ca00405aa28329c80a1d5
---

# Предварительные требования

**Примечание:** Платформа в настоящее время **не поддерживает прямую установку управляющего кластера в существующей среде Kubernetes**. Пожалуйста, заранее подготовьте виртуальные или физические машины, которые соответствуют требованиям, и строго следуйте предварительным требованиям, изложенным ниже, для подготовки развертывания.

В следующем содержании подробно описаны требования к аппаратному обеспечению, сети, операционной системе и ядру для установки управляющего кластера, а также шаги по предварительной обработке узлов.

### 1. Требования к ресурсам машин

**Совет:** Этот раздел описывает минимальные аппаратные требования для создания высокодоступного управляющего кластера. Если вы завершили планирование емкости, пожалуйста, обратитесь к [Планированию емкости](#scale) для подготовки необходимых ресурсов или увеличьте их по мере необходимости после установки.

#### 1.1 Требования к базовой конфигурации

Необходимо предоставить как минимум **3** физических или виртуальных машины в качестве управляющих узлов для управляющего кластера, с следующими минимальными конфигурациями для каждого узла:

| **Категория** | **Минимальные требования**                                                                            |
| ------------- | ----------------------------------------------------------------------------------------------------- |
| **ЦП**        | ≥ 8 ядер, тактовая частота ≥ 2.5GHz<br />Без перепродаж; отключите режим энергосбережения             |
| **Память**    | ≥ 16 ГБ<br />Без перепродаж; рекомендуется не менее шестиканальной DDR4                               |
| **Диск**      | IOPS одного устройства ≥ 2000<br />Пропускная способность ≥ 200 МБ/с<br />Обязательно используйте SSD |

#### 1.2 Требования к архитектуре ARM

Для архитектуры ARM (например, Kunpeng 920) рекомендуется увеличить минимальную конфигурацию до **двукратной** по сравнению с x86, но не менее **1.5 раз**.
Например: Если требование для x86 составляет 8 ядер и 16 ГБ, минимальные требования для ARM должны составлять 12 ядер и 24 ГБ, с рекомендуемой конфигурацией 16 ядер и 32 ГБ.

#### 1.3 Описание специальной среды

- **Развертывание на одном узле:** Если представлена только 1 машина, можно установить управляющий кластер на одном узле, но **это ограничивается не производственными средами**. В производственных средах необходимо настроить как минимум 3 машины для высокой доступности.

---

### 2. Поддерживаемые операционные системы и ядра

#### 2.1 Архитектура x86

**Red Hat Enterprise Linux (RHEL)**

- **Поддерживаемые версии и ядра:**
  - RHEL 7.8: `3.10.0-1127.el7.x86_64`
  - RHEL 8.0 до 8.6: `4.18.0-80.el8.x86_64` до `4.18.0-372.9.1.el8.x86_64`
- **Примечание:** RHEL 7.8 не поддерживает **Calico Vxlan IPv6**.

**CentOS**

- **Поддерживаемые версии и ядра:**
  - CentOS 7.6 до 7.9: `3.10.0-1127` до `3.11`
- **Примечание:** Не поддерживает **Calico Vxlan IPv6**.

**Ubuntu**

- **Поддерживаемые версии и ядра:**
  - Ubuntu 20.04 LTS: `5.4.0-124-generic`
  - Ubuntu 22.04 LTS: `5.15.0-56-generic`
- **Примечание:** Не поддерживает версии Ubuntu HWE (Аппаратное расширение).

**Kylin Linux (Kylin Linux Advanced Server)**

- **Поддерживаемые версии и ядра:**
  - Kylin V10: `4.19.90-11.ky10.x86_64`
  - Kylin V10 SP1: `4.19.90-23.8.v2101.ky10.x86_64`
  - Kylin V10 SP2: `4.19.90-24.4.v2101.ky10.x86_64`
  - Kylin V10 SP3: `4.19.90-52.22.v2207.ky10.x86_64`
- **Важное замечание:** В Kylin V10, V10-SP1 и V10-SP2 существуют известные проблемы с ядром, которые могут вызвать **неисправности в доступе к сети NodePort**; рекомендуется обновиться до **Kylin V10-SP3**.

---

#### 2.2 Архитектура ARM (Kunpeng 920)

**Kylin Linux (Kylin Linux Advanced Server)**

- **Поддерживаемые версии и ядра:**
  - Kylin V10: `4.19.90-11.ky10.aarch64`
  - Kylin V10 SP1: `4.19.90-17.ky10.aarch64`
  - Kylin V10 SP2: `4.19.90-24.4.v2101.ky10.aarch64`
  - Kylin V10 SP3: `4.19.90-52.22.v2207.ky10.aarch64`
- **Важное замечание:** Также рекомендуется обновиться до **Kylin V10-SP3**, чтобы избежать проблем с доступом к сети NodePort.

---

#### 2.3 Другие важные замечания

1. **Требования к версиям ядер:**
   Указанные выше версии ядра являются официальными релизами, протестированными и проверенными платформой. Во время фактического развертывания убедитесь, что **основной номер версии A.B.C** совпадает; последующие части могут допускать расхождения.

2. **Неподдерживаемые среды:**
   Если операционная система, версия ядра или архитектура ЦП не соответствуют требованиям, пожалуйста, свяжитесь с технической поддержкой.

3. **Развертывание пользовательской системы:**
   Если вы используете пользовательскую систему или развертывание в специальной среде, пожалуйста, завершите тестирование совместимости и скорректируйте в соответствии с фактическими условиями.

4. **Требования к установке Ceph:**
   Если планируется установка Ceph, убедитесь, что версия ядра составляет не менее `4.11`.

---

### 3. Предварительная обработка машин

Перед установкой управляющего кластера все узлы (управляющие узлы и вычислительные узлы) должны завершить задачи предварительной обработки.

#### 3.1 Выполните сценарий быстрой настройки

**Подготовка**
Подтвердите, что установочный пакет был распакован, и убедитесь, что у вас есть привилегии `root`.

**Выполнение**
Запустите сценарий, расположенный по адресу `res/init.sh`:

```bash
bash res/init.sh
```

**Проверка**
Проверьте журналы сценария, чтобы подтвердить, что элементы конфигурации системы были настроены как требуется.

**Примечание:** Сценарий `init.sh` не может гарантировать, что все следующие проверки обработаны должным образом; вам все равно нужно продолжить следующие шаги, чтобы подтвердить, что каждая машина соответствует всем требованиям проверочных элементов.

#### 3.2 Проверьте локальные требования

Проверьте следующие требования по пунктам, чтобы убедиться, что локальная среда соответствует требованиям установки:

- **Конфигурация операционной системы и ядра:**

  - [x] Конфигурация загрузки grub включает параметр `transparent_hugepage=never`.
  - \[!] Системы CentOS 7.x должны добавить параметр `cgroup.memory=nokmem` в конфигурацию grub.
  - [x] Когда версия ядра ниже 4.19.0 (или RHEL ниже 4.18.0), убедитесь, что модули `nf_conntrack_ipv4` и (для IPv6) `nf_conntrack_ipv6` включены.
  - \[!] Если используется CNI `Kube-OVN`, модули `geneve` и `openvswitch` должны быть включены.
  - [x] Проверьте состояние загрузки модулей `ip_vs`, `ip_vs_rr`, `ip_vs_wrr` и `ip_vs_sh`.
  - [x] Отключите функции apparmor/selinux и фаервола.
  - [x] Отключите своп.

- **Настройки пользователя и разрешений:**

  - [x] Пользователи SSH имеют привилегии `root` и могут использовать `sudo` без пароля.
  - [x] Параметры `UseDNS` и `UsePAM` в `/etc/ssh/sshd_config` установлены в `no`.
  - [x] `systemctl show --property=DefaultTasksMax` возвращает `infinity` или очень большое значение; если нет, отрегулируйте `/etc/systemd/system.conf`.

- **Сеть и имя хоста:**

  - [x] Требования к имени хоста: не более 36 символов, начинающееся и заканчивающееся буквами или цифрами, содержащие только строчные буквы, цифры, `-` и `.` (не должно содержать `.-`, `..` или `-.`).
  - [x] `localhost` в `/etc/hosts` должен разрешаться в `127.0.0.1`.
  - [x] Файл `/etc/resolv.conf` существует и содержит конфигурацию `nameserver`, но не должен включать адреса, начинающиеся с 172 (отключите systemd-resolved).
  - \[!] Файл `/etc/resolv.conf` не должен настраивать домен поиска (если такое конфигurado необходимо, обратитесь к [Настройте домен поиска](#config_search)).
  - [x] IP-адреса не должны быть адресами обратной связи, мультикастами, локальными адресами, адресами все нули или широковещательными адресами.
  - [x] Выход `ip route` должен включать маршрут по умолчанию или маршрут, указывающий на `0.0.0.0`.
  - [x] Узлы управляющего кластера не должны занимать следующие порты:
    - **Управляющие узлы:** 2379, 2380, 6443, 10249-10256
    - **Узлы-инсталляторы:** 8080, 12080, 12443, 16443 и все порты управляющего узла
    - **Вычислительные узлы:** 10249-10256
  - [x] Если используется **Kube-OVN** или **Calico**, убедитесь, что следующие порты не заняты:
    - **Kube-OVN:** 6641, 6642
    - **Calico:** 179
  - \[!] Убедитесь, что диапазон, необходимый для Docker, от 172.16.x.x до 172.32.x.x не занят; в случае конфликта, пожалуйста, свяжитесь с технической поддержкой.

- **Требования к программному обеспечению и каталогам:**
  - [x] Убедитесь, что в системе установлены команды `ip`, `ss`, `tar`, `swapoff`, `modprobe`, `sysctl`, `md5sum` и `scp` или `sftp`.
  - \[!] Если используется решение для локального хранения (например, TopoLVM или Rook), пожалуйста, установите `lvm2`.
  - [x] Файл `/etc/systemd/system/kubelet.service` не должен существовать.
  - [x] Очистите файлы в следующих каталогах:
    - `/var/lib/docker`
    - `/var/lib/containerd`
    - `/var/log/pods`
    - `/var/lib/kubelet/pki`
  - [x] Проверьте, достаточно ли свободного места в `/var/lib`.
  - [x] Параметры монтирования для `/tmp` не должны включать `noexec`.
  - [x] Удалите потенциально конфликтующие пакетные программные продукты с компонентами платформы (см. [Удалить конфликтующие пакеты](#remove_conflicting_packages) для деталей).

#### 3.3 Проверка между узлами

- Не должно быть ограничений фаервола между узлами.
- Имя хоста каждого узла должно быть уникальным.
- Все узлы должны иметь синхронизированные временные зоны, и ошибка синхронизации времени не должна превышать 10 секунд.

---

### 4. Приложение

#### 4.1 Удалить конфликтующие пакеты <a id="remove_conflicting_packages" />

Пожалуйста, используйте следующие команды для проверки и удаления любых пакетов, которые могут конфликтовать с компонентами платформы в соответствии с вашей операционной системой.

**_CentOS / RedHat_**

**Команда проверки:**

```bash
for x in \
    docker docker-client docker-common docker-latest \
    podman-docker podman \
    runc \
    containernetworking-plugins \
    apptainer \
    kubernetes kubernetes-master kubernetes-node kubernetes-client; do
    rpm -qa | grep -F "$x"
done
```

**Команда удаления:**

```bash
for x in \
    docker docker-client docker-common docker-latest \
    podman-docker podman \
    runc \
    containernetworking-plugins \
    apptainer \
    kubernetes kubernetes-master kubernetes-node kubernetes-client; do
    yum remove "$x"
done
```

**_Ubuntu_**

**Команда проверки:**

```bash
for x in \
    docker.io \
    podman-docker \
    containerd \
    rootlesskit \
    rkt \
    containernetworking-plugins \
    kubernetes; do
    dpkg-query -l | grep -F "$x"
done

for x in \
    kubernetes-worker \
    kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
    k8s microk8s \
    kubeadm kubelet; do
    snap list | grep -F "$x"
done
```

**Команда удаления:**

```bash
for x in \
    docker.io \
    podman-docker \
    containerd \
    rootlesskit \
    rkt \
    containernetworking-plugins \
    kubernetes; do
    apt-get purge "$x"
done

for x in \
    kubernetes-worker \
    kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
    k8s microk8s \
    kubeadm kubelet; do
    snap remove --purge "$x"
done
```

**_KylinOS_**

**Команда проверки:**

```bash
for x in \
    docker docker-client docker-common \
    docker-engine docker-proxy docker-runc \
    podman-docker podman \
    containernetworking-plugins \
    apptainer \
    containerd \
    kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm; do
    rpm -qa | grep -F "$x"
done
```

**Команда удаления:**

```bash
for x in \
    docker docker-client docker-common \
    docker-engine docker-proxy docker-runc \
    podman-docker podman \
    containernetworking-plugins \
    apptainer \
    containerd \
    kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm; do
    yum remove "$x"
done
```

---

#### 4.2 Настроить домен поиска <a id="config_search" />

В файле `/etc/resolv.conf` строка `search` указывает путь поиска DNS-запросов, и требования к конфигурации следующие:

- **Количество доменов:** Количество доменов поиска для хоста должно быть меньше `domainCountLimit - 3` (по умолчанию `domainCountLimit` составляет 32).
- **Общая длина символов:** Общее количество символов для всех доменных имен и пробелов не должно превышать `MaxDNSSearchListChar` (обычно 2048).
- **Длина отдельного домена:** Каждое доменное имя не должно превышать 253 символа.

Несоблюдение этих требований может привести к сбоям DNS-запросов или снижению производительности; пожалуйста, свяжитесь с инженером по обслуживанию для корректировок.

---

### 5. Требования к сетевым ресурсам

Перед установкой управляющего кластера следующие сетевые ресурсы должны быть предварительно настроены. Если оборудование LoadBalancer не может быть предоставлено, инсталлятор поддерживает настройку **haproxy + keepalived** как программного балансировщика нагрузки, но это может повлиять на производительность и надежность.

#### 5.1 Конфигурация сетевых ресурсов

| **Ресурс**         | **Обязательный** | **Количество** | **Описание**                                                                                                                                                                                                                                                                     |
| ------------------ | ---------------- | -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Глобальный VIP** | Обязательно      | 1              | Используется для доступа к kube-apiserver со всех узлов в управляющем кластере, настраивается на устройстве балансировки нагрузки для обеспечения высокой доступности. Если управляющий кластер и кластер служб находятся в одной сети, этот IP будет уникальной точкой доступа. |
| **Внешний IP**     | Необязательно    | 1              | Используется для доступа к управляющему кластеру через сети (например, гибридное облако), настраивается на устройстве балансировки нагрузки; также может служить адресом доступа для Web UI платформы.                                                                           |
| **Домен**          | Необязательно    | 1              | Если требуется доступ к управляющему кластеру или платформе Web UI через доменное имя, пожалуйста, предоставьте его заранее и убедитесь, что домен разрешается правильно.                                                                                                        |
| **Сертификат**     | Необязательно    | 1              | Рекомендуется использовать доверенный сертификат, чтобы избежать предупреждений безопасности браузера; если не предоставлен, инсталлятор сгенерирует самоподписанный сертификат, что может вызвать риски безопасности при использовании HTTPS.                                   |

**Особое примечание**
Необходимо предоставить доменное имя в следующих случаях:

1. Для поддержки доступа к управляющему кластеру по протоколу IPv6;
2. Для реализации решений по восстановлению после сбоев для управляющего кластера.

#### 5.2 Требования к сетевой конфигурации

| **Тип**                 | **Описание требований**                                                                                                                                                                                                                                                                                              |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Сетевая скорость**    | Скорость между управляющим кластером и кластером служб в одной сети должна составлять ≥ 1 Гбит/с (рекомендуется 10 Гбит/с); между сетями скорость должна составлять ≥ 100 Мбит/с (рекомендуется 1 Гбит/с). Недостаточная скорость повлияет на производительность журнала и запросов аудита.                          |
| **Сетевая задержка**    | Задержка в одной сети ≤ 2 мс; между сетями ≤ 100 мс (рекомендуется ≤ 30 мс).                                                                                                                                                                                                                                         |
| **Сетевая политика**    | Рекомендуется отсутствовать ограничения фаервола между управляющим кластером и кластером служб; если существуют ограничения, обратитесь к [Правилам переадресации портов](#port-forward), чтобы убедиться, что необходимые порты открыты; при использовании CNI Calico убедитесь, что протокол **IP-in-IP** включен. |
| **Диапазон IP-адресов** | Узлы управляющего кластера должны избегать использования диапазона 172.16-32; если уже используется, пожалуйста, перезагрузите конфигурацию Docker (добавляя параметр bip), чтобы избежать конфликтов.                                                                                                               |

#### 5.3 Правила переадресации портов <a id="port-forward" />

Чтобы убедиться, что управляющий кластер может принимать внешний трафик, перенаправленный LoadBalancer, пожалуйста, настройте следующие правила:

| **Источник доступа/Источник IP** | **Протокол переадресации** | **Целевой IP**       | **Целевой порт** | **Примечания**                                                                                                                                           |
| -------------------------------- | -------------------------- | -------------------- | ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ПК пользователя или `any`        | TCP                        | IP узла инсталлятора | 8080             | Доступ к веб-интерфейсу управляющего кластера; это правило можно удалить после установки.                                                                |
| LoadBalancer                     | TCP                        | IP управляющего узла | 443              | Порт по умолчанию для HTTPS Web UI платформы, репозитория изображений и внешнего доступа к apiserver; поддерживает пользовательские параметры установки. |

**Другие требования к конфигурации:**

1. **Конфигурация LoadBalancer:**

   - Пожалуйста, смотрите соответствующую документацию для конкретных методов настройки.
   - Рекомендуется настраивать проверки состояния, чтобы контролировать состояние портов.

2. **Решения по восстановлению после сбоев:**

   - Если планируется восстановление после сбоев, порт 2379 должен быть открыт для всех управляющих узлов для синхронизации данных ETCD между основным кластером и кластером восстановления после сбоев.

3. **Поддержка HTTP:**
   - Платформа по умолчанию поддерживает только HTTPS; если необходима поддержка HTTP, пожалуйста, дополнительно настройте порт 80 (или пользовательский порт), с правилами, идентичными правилам для конфигурации HTTPS.
